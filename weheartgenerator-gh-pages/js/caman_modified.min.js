function lerp(e,t,n){return(t-e)*n+e}(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N={}.hasOwnProperty,C=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++){if(t in this&&this[t]===e)return t}return-1},k=[].slice,L=this;x=Array.prototype.slice;e=function(e,t){if(t==null){t=document}if(typeof e==="object"||typeof exports!=="undefined"&&exports!==null){return e}return t.querySelector(e)};E=function(){function e(){}e.uniqid=function(){var e;e=0;return{get:function(){return e++}}}();e.extend=function(e){var t,n,r,i,s,o;n=e;i=x.call(arguments,1);for(s=0,o=i.length;s<o;s++){t=i[s];for(r in t){if(!N.call(t,r))continue;n[r]=t[r]}}return n};e.clampRGB=function(e){if(e<0){return 0}if(e>255){return 255}return e};e.copyAttributes=function(e,t,n){var r,i,s,o,u,a;if(n==null){n={}}o=e.attributes;a=[];for(i=0,s=o.length;i<s;i++){r=o[i];if(n.except!=null&&(u=r.nodeName,C.call(n.except,u)>=0)){continue}a.push(t.setAttribute(r.nodeName,r.nodeValue))}return a};e.dataArray=function(e){if(e==null){e=0}if(i.NodeJS||window.Uint8Array!=null){return new Uint8Array(e)}return new Array(e)};return e}();if(typeof exports!=="undefined"&&exports!==null){b=exports;o=require("canvas");h=o.Image;f=require("fibers");S=require("fs")}else{b=window}b.Caman=i=function(){function n(){var e,r,i,s=this;if(arguments.length===0){throw"Invalid arguments"}if(this instanceof n){this.finishInit=this.finishInit.bind(this);this.imageLoaded=this.imageLoaded.bind(this);e=arguments[0];if(!n.NodeJS){i=parseInt(n.getAttrId(e[0]),10);r=typeof e[1]==="function"?e[1]:typeof e[2]==="function"?e[2]:function(){};if(!isNaN(i)&&w.has(i)){return w.execute(i,r)}}this.id=E.uniqid.get();this.initializedPixelData=this.originalPixelData=null;this.cropCoordinates={x:0,y:0};this.cropped=false;this.resized=false;this.pixelStack=[];this.layerStack=[];this.canvasQueue=[];this.currentLayer=null;this.scaled=false;this.analyze=new t(this);this.renderer=new y(this);this.domIsLoaded(function(){s.parseArguments(e);return s.setup()});return this}else{return new n(arguments)}}n.version={release:"4.1.1",date:"4/8/2013"};n.DEBUG=false;n.NodeJS=typeof exports!=="undefined"&&exports!==null;n.autoload=!n.NodeJS;n.allowRevert=true;n.crossOrigin="anonymous";n.toString=function(){return"Version "+n.version.release+", Released "+n.version.date};n.remoteProxy="";n.proxyParam="camanProxyUrl";n.getAttrId=function(t){if(n.NodeJS){return true}if(typeof t==="string"){t=e(t)}if(!(t!=null&&t.getAttribute!=null)){return null}return t.getAttribute("data-caman-id")};n.prototype.domIsLoaded=function(e){var t,r=this;if(n.NodeJS){return setTimeout(function(){return e.call(r)},0)}else{if(document.readyState==="complete"){d.debug("DOM initialized");return setTimeout(function(){return e.call(r)},0)}else{t=function(){if(document.readyState==="complete"){d.debug("DOM initialized");return e.call(r)}};return document.addEventListener("readystatechange",t,false)}}};n.prototype.parseArguments=function(e){var t,n,r,i;if(e.length===0){throw"Invalid arguments given"}this.initObj=null;this.initType=null;this.imageUrl=null;this.callback=function(){};this.setInitObject(e[0]);if(e.length===1){return}switch(typeof e[1]){case"string":this.imageUrl=e[1];break;case"function":this.callback=e[1]}if(e.length===2){return}this.callback=e[2];if(e.length===4){r=e[4];i=[];for(t in r){if(!N.call(r,t))continue;n=r[t];i.push(this.options[t]=n)}return i}};n.prototype.setInitObject=function(t){if(n.NodeJS){this.initObj=t;this.initType="node";return}if(typeof t==="object"){this.initObj=t}else{this.initObj=e(t)}if(this.initObj==null){throw"Could not find image or canvas for initialization."}return this.initType=this.initObj.nodeName.toLowerCase()};n.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas()}};n.prototype.initNode=function(){var e=this;d.debug("Initializing for NodeJS");this.image=new h;this.image.onload=function(){d.debug("Image loaded. Width = "+e.imageWidth()+", Height = "+e.imageHeight());e.canvas=new o(e.imageWidth(),e.imageHeight());return e.finishInit()};this.image.onerror=function(e){throw e};return this.image.src=this.initObj};n.prototype.initImage=function(){this.image=this.initObj;this.canvas=document.createElement("canvas");this.context=this.canvas.getContext("2d");E.copyAttributes(this.image,this.canvas,{except:["src"]});this.image.parentNode.replaceChild(this.canvas,this.image);this.imageAdjustments();return this.waitForImageLoaded()};n.prototype.initCanvas=function(){this.canvas=this.initObj;this.context=this.canvas.getContext("2d");if(this.imageUrl!=null){this.image=document.createElement("img");this.image.src=this.imageUrl;this.imageAdjustments();return this.waitForImageLoaded()}else{return this.finishInit()}};n.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()){d.debug(this.image.src,"->",this.hiDPIReplacement());this.swapped=true;this.image.src=this.hiDPIReplacement()}if(c.isRemote(this.image)){this.image.src=c.proxyUrl(this.image.src);return d.debug("Remote image detected, using URL = "+this.image.src)}};n.prototype.waitForImageLoaded=function(){if(this.isImageLoaded()){return this.imageLoaded()}else{return this.image.onload=this.imageLoaded}};n.prototype.isImageLoaded=function(){if(!this.image.complete){return false}if(this.image.naturalWidth!=null&&this.image.naturalWidth===0){return false}return true};n.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth};n.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight};n.prototype.imageLoaded=function(){d.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight());if(this.swapped){this.canvas.width=this.imageWidth()/this.hiDPIRatio();this.canvas.height=this.imageHeight()/this.hiDPIRatio()}else{this.canvas.width=this.imageWidth();this.canvas.height=this.imageHeight()}return this.finishInit()};n.prototype.finishInit=function(){var e,t,r,i,s;if(this.context==null){this.context=this.canvas.getContext("2d")}this.originalWidth=this.preScaledWidth=this.width=this.canvas.width;this.originalHeight=this.preScaledHeight=this.height=this.canvas.height;this.hiDPIAdjustments();if(!this.hasId()){this.assignId()}if(this.image!=null){this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight)}this.reloadCanvasData();if(n.allowRevert){this.initializedPixelData=E.dataArray(this.pixelData.length);this.originalPixelData=E.dataArray(this.pixelData.length);s=this.pixelData;for(e=r=0,i=s.length;r<i;e=++r){t=s[e];this.initializedPixelData[e]=t;this.originalPixelData[e]=t}}this.dimensions={width:this.canvas.width,height:this.canvas.height};w.put(this.id,this);this.callback.call(this,this);return this.callback=function(){}};n.prototype.reloadCanvasData=function(){this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);return this.pixelData=this.imageData.data};n.prototype.resetOriginalPixelData=function(){var e,t,r,i,s;if(!n.allowRevert){throw"Revert disabled"}this.originalPixelData=E.dataArray(this.pixelData.length);i=this.pixelData;s=[];for(t=0,r=i.length;t<r;t++){e=i[t];s.push(this.originalPixelData.push(e))}return s};n.prototype.hasId=function(){return n.getAttrId(this.canvas)!=null};n.prototype.assignId=function(){if(n.NodeJS||this.canvas.getAttribute("data-caman-id")){return}return this.canvas.setAttribute("data-caman-id",this.id)};n.prototype.hiDPIDisabled=function(){return this.canvas.getAttribute("data-caman-hidpi-disabled")!==null};n.prototype.hiDPIAdjustments=function(){var e;if(n.NodeJS||this.hiDPIDisabled()){return}e=this.hiDPIRatio();if(e!==1){d.debug("HiDPI ratio = "+e);this.scaled=true;this.preScaledWidth=this.canvas.width;this.preScaledHeight=this.canvas.height;this.canvas.width=this.preScaledWidth*e;this.canvas.height=this.preScaledHeight*e;this.canvas.style.width=""+this.preScaledWidth+"px";this.canvas.style.height=""+this.preScaledHeight+"px";this.context.scale(e,e);this.width=this.originalWidth=this.canvas.width;return this.height=this.originalHeight=this.canvas.height}};n.prototype.hiDPIRatio=function(){var e,t;t=window.devicePixelRatio||1;e=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1;return t/e};n.prototype.hiDPICapable=function(){return window.devicePixelRatio!=null&&window.devicePixelRatio!==1};n.prototype.needsHiDPISwap=function(){if(this.hiDPIDisabled()||!this.hiDPICapable()){return false}return this.hiDPIReplacement()!==null};n.prototype.hiDPIReplacement=function(){if(this.image==null){return null}return this.image.getAttribute("data-caman-hidpi")};n.prototype.replaceCanvas=function(e){var t;t=this.canvas;this.canvas=e;this.context=this.canvas.getContext("2d");t.parentNode.replaceChild(this.canvas,t);this.width=this.canvas.width;this.height=this.canvas.height;this.reloadCanvasData();return this.dimensions={width:this.canvas.width,height:this.canvas.height}};n.prototype.render=function(e){var t=this;if(e==null){e=function(){}}a.trigger(this,"renderStart");return this.renderer.execute(function(){t.context.putImageData(t.imageData,0,0);return e.call(t)})};n.prototype.revert=function(){var e,t,r,i,s;if(!n.allowRevert){throw"Revert disabled"}s=this.originalVisiblePixels();for(e=r=0,i=s.length;r<i;e=++r){t=s[e];this.pixelData[e]=t}return this.context.putImageData(this.imageData,0,0)};n.prototype.reset=function(){var e,t,n,r,i,s,o,u,a;e=document.createElement("canvas");E.copyAttributes(this.canvas,e);e.width=this.originalWidth;e.height=this.originalHeight;t=e.getContext("2d");r=t.getImageData(0,0,e.width,e.height);s=r.data;a=this.initializedPixelData;for(n=o=0,u=a.length;o<u;n=++o){i=a[n];s[n]=i}t.putImageData(r,0,0);this.cropCoordinates={x:0,y:0};this.resized=false;return this.replaceCanvas(e)};n.prototype.originalVisiblePixels=function(){var e,t,r,i,s,o,u,a,f,l,c,h,p,d,v,g,y,b,w,E,S;if(!n.allowRevert){throw"Revert disabled"}l=[];h=this.cropCoordinates.x;i=h+this.width;p=this.cropCoordinates.y;s=p+this.height;if(this.resized){e=document.createElement("canvas");e.width=this.originalWidth;e.height=this.originalHeight;r=e.getContext("2d");u=r.getImageData(0,0,e.width,e.height);f=u.data;b=this.originalPixelData;for(o=v=0,y=b.length;v<y;o=++v){a=b[o];f[o]=a}r.putImageData(u,0,0);c=document.createElement("canvas");c.width=this.width;c.height=this.height;r=c.getContext("2d");r.drawImage(e,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height);f=r.getImageData(0,0,this.width,this.height).data;d=this.width}else{f=this.originalPixelData;d=this.originalWidth}for(o=g=0,w=f.length;g<w;o=g+=4){t=m.locationToCoordinates(o,d);if(h<=(E=t.x)&&E<i&&p<=(S=t.y)&&S<s){l.push(f[o],f[o+1],f[o+2],f[o+3])}}return l};n.prototype.process=function(e,t){this.renderer.add({type:l.Type.Single,name:e,processFn:t});return this};n.prototype.processKernel=function(e,t,n,r){var i,s,o;if(!n){n=0;for(i=s=0,o=t.length;0<=o?s<o:s>o;i=0<=o?++s:--s){n+=t[i]}}this.renderer.add({type:l.Type.Kernel,name:e,adjust:t,divisor:n,bias:r||0});return this};n.prototype.processPlugin=function(e,t){this.renderer.add({type:l.Type.Plugin,plugin:e,args:t});return this};n.prototype.newLayer=function(e){var t;t=new p(this);this.canvasQueue.push(t);this.renderer.add({type:l.Type.LayerDequeue});e.call(t);this.renderer.add({type:l.Type.LayerFinished});return this};n.prototype.executeLayer=function(e){return this.pushContext(e)};n.prototype.pushContext=function(e){this.layerStack.push(this.currentLayer);this.pixelStack.push(this.pixelData);this.currentLayer=e;return this.pixelData=e.pixelData};n.prototype.popContext=function(){this.pixelData=this.pixelStack.pop();return this.currentLayer=this.layerStack.pop()};n.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent()};return n}();t=function(){function e(e){this.c=e}e.prototype.calculateLevels=function(){var e,t,n,r,i,s,o;t={r:{},g:{},b:{}};for(e=r=0;r<=255;e=++r){t.r[e]=0;t.g[e]=0;t.b[e]=0}for(e=i=0,o=this.c.pixelData.length;i<o;e=i+=4){t.r[this.c.pixelData[e]]++;t.g[this.c.pixelData[e+1]]++;t.b[this.c.pixelData[e+2]]++}n=this.c.pixelData.length/4;for(e=s=0;s<=255;e=++s){t.r[e]/=n;t.g[e]/=n;t.b[e]/=n}return t};return e}();i.DOMUpdated=function(){var e,t,n,r,i,o;t=document.querySelectorAll("img[data-caman]");if(!(t.length>0)){return}o=[];for(r=0,i=t.length;r<i;r++){e=t[r];o.push(n=new s(e,function(){this.parse();return this.execute()}))}return o};if(i.autoload){(function(){if(document.readyState==="complete"){return i.DOMUpdated()}else{return document.addEventListener("DOMContentLoaded",i.DOMUpdated,false)}})()}s=function(){function t(e,t){this.dataStr=e.getAttribute("data-caman");this.caman=i(e,t.bind(this))}var e;e="(\\w+)\\((.*?)\\)";t.prototype.parse=function(){var t,n,r,i,s,o,u,a,f,l,c,h;this.ele=this.caman.canvas;u=new RegExp(e,"g");a=this.dataStr.match(u);if(!(a.length>0)){return}u=new RegExp(e);h=[];for(f=0,l=a.length;f<l;f++){i=a[f];c=i.match(u),o=c[0],n=c[1],t=c[2];s=new Function("return function() {        this."+n+"("+t+");      };");try{r=s();h.push(r.call(this.caman))}catch(p){h.push(d.debug(p))}}return h};t.prototype.execute=function(){var e;e=this.ele;return this.caman.render(function(){return e.parentNode.replaceChild(this.toImage(),e)})};return t}();i.Blender=n=function(){function e(){}e.blenders={};e.register=function(e,t){return this.blenders[e]=t};e.execute=function(e,t,n){return this.blenders[e](t,n)};return e}();i.Calculate=r=function(){function e(){}e.distance=function(e,t,n,r){return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))};e.randomRange=function(e,t,n){var r;if(n==null){n=false}r=e+Math.random()*(t-e);if(n){return r.toFixed(n)}else{return Math.round(r)}};e.luminance=function(e){return.299*e.r+.587*e.g+.114*e.b};e.bezier=function(e,t,n,r,i,s){var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_;w=e[0];T=e[1];E=t[0];N=t[1];S=n[0];C=n[1];x=r[0];k=r[1];h={};l=parseInt(3*(E-w),10);a=3*(S-E)-l;o=x-w-l-a;c=3*(N-T);f=3*(C-N)-c;u=k-T-c-f;for(v=L=0;L<1e3;v=++L){b=v/1e3;p=Math.round(o*Math.pow(b,3)+a*Math.pow(b,2)+l*b+w);d=Math.round(u*Math.pow(b,3)+f*Math.pow(b,2)+c*b+T);if(i&&d<i){d=i}else if(s&&d>s){d=s}h[p]=d}if(h.length<r[0]+1){for(v=A=0,M=r[0];0<=M?A<=M:A>=M;v=0<=M?++A:--A){if(h[v]==null){g=[v-1,h[v-1]];for(m=O=v,_=r[0];v<=_?O<=_:O>=_;m=v<=_?++O:--O){if(h[m]!=null){y=[m,h[m]];break}}h[v]=g[1]+(y[1]-g[1])/(y[0]-g[0])*(v-g[0])}}}if(h[r[0]]==null){h[r[0]]=h[r[0]-1]}return h};return e}();u=function(){function e(){}e.hexToRGB=function(e){var t,n,r;if(e.charAt(0)==="#"){e=e.substr(1)}r=parseInt(e.substr(0,2),16);n=parseInt(e.substr(2,2),16);t=parseInt(e.substr(4,2),16);return{r:r,g:n,b:t}};e.rgbToHSL=function(e,t,n){var r,i,s,o,u,a;if(typeof e==="object"){t=e.g;n=e.b;e=e.r}e/=255;t/=255;n/=255;o=Math.max(e,t,n);u=Math.min(e,t,n);s=(o+u)/2;if(o===u){i=a=0}else{r=o-u;a=s>.5?r/(2-o-u):r/(o+u);i=function(){switch(o){case e:return(t-n)/r+(t<n?6:0);case t:return(n-e)/r+2;case n:return(e-t)/r+4}}();i/=6}return{h:i,s:a,l:s}};e.hslToRGB=function(e,t,n){var r,i,s,o,u;if(typeof e==="object"){t=e.s;n=e.l;e=e.h}if(t===0){u=i=r=n}else{o=n<.5?n*(1+t):n+t-n*t;s=2*n-o;u=this.hueToRGB(s,o,e+1/3);i=this.hueToRGB(s,o,e);r=this.hueToRGB(s,o,e-1/3)}return{r:u*255,g:i*255,b:r*255}};e.hueToRGB=function(e,t,n){if(n<0){n+=1}if(n>1){n-=1}if(n<1/6){return e+(t-e)*6*n}if(n<1/2){return t}if(n<2/3){return e+(t-e)*(2/3-n)*6}return e};e.rgbToHSV=function(e,t,n){var r,i,s,o,u,a;e/=255;t/=255;n/=255;s=Math.max(e,t,n);o=Math.min(e,t,n);a=s;r=s-o;u=s===0?0:r/s;if(s===o){i=0}else{i=function(){switch(s){case e:return(t-n)/r+(t<n?6:0);case t:return(n-e)/r+2;case n:return(e-t)/r+4}}();i/=6}return{h:i,s:u,v:a}};e.hsvToRGB=function(e,t,n){var r,i,s,o,u,a,f,l;o=Math.floor(e*6);i=e*6-o;u=n*(1-t);a=n*(1-i*t);l=n*(1-(1-i)*t);switch(o%6){case 0:f=n;s=l;r=u;break;case 1:f=a;s=n;r=u;break;case 2:f=u;s=n;r=l;break;case 3:f=u;s=a;r=n;break;case 4:f=l;s=u;r=n;break;case 5:f=n;s=u;r=a}return{r:f*255,g:s*255,b:r*255}};e.rgbToXYZ=function(e,t,n){var r,i,s;e/=255;t/=255;n/=255;if(e>.04045){e=Math.pow((e+.055)/1.055,2.4)}else{e/=12.92}if(t>.04045){t=Math.pow((t+.055)/1.055,2.4)}else{t/=12.92}if(n>.04045){n=Math.pow((n+.055)/1.055,2.4)}else{n/=12.92}r=e*.4124+t*.3576+n*.1805;i=e*.2126+t*.7152+n*.0722;s=e*.0193+t*.1192+n*.9505;return{x:r*100,y:i*100,z:s*100}};e.xyzToRGB=function(e,t,n){var r,i,s;e/=100;t/=100;n/=100;s=3.2406*e+ -1.5372*t+ -.4986*n;i=-.9689*e+1.8758*t+.0415*n;r=.0557*e+ -.204*t+1.057*n;if(s>.0031308){s=1.055*Math.pow(s,.4166666667)-.055}else{s*=12.92}if(i>.0031308){i=1.055*Math.pow(i,.4166666667)-.055}else{i*=12.92}if(r>.0031308){r=1.055*Math.pow(r,.4166666667)-.055}else{r*=12.92}return{r:s*255,g:i*255,b:r*255}};e.xyzToLab=function(e,t,n){var r,i,s,o,u,a;if(typeof e==="object"){t=e.y;n=e.z;e=e.x}o=95.047;u=100;a=108.883;e/=o;t/=u;n/=a;if(e>.008856451679){e=Math.pow(e,.3333333333)}else{e=7.787037037*e+.1379310345}if(t>.008856451679){t=Math.pow(t,.3333333333)}else{t=7.787037037*t+.1379310345}if(n>.008856451679){n=Math.pow(n,.3333333333)}else{n=7.787037037*n+.1379310345}s=116*t-16;r=500*(e-t);i=200*(t-n);return{l:s,a:r,b:i}};e.labToXYZ=function(e,t,n){var r,i,s;if(typeof e==="object"){t=e.a;n=e.b;e=e.l}i=(e+16)/116;r=i+t/500;s=i-n/200;if(r>.2068965517){r=r*r*r}else{r=.1284185493*(r-.1379310345)}if(i>.2068965517){i=i*i*i}else{i=.1284185493*(i-.1379310345)}if(s>.2068965517){s=s*s*s}else{s=.1284185493*(s-.1379310345)}return{x:r*95.047,y:i*100,z:s*108.883}};e.rgbToLab=function(e,t,n){var r;if(typeof e==="object"){t=e.g;n=e.b;e=e.r}r=this.rgbToXYZ(e,t,n);return this.xyzToLab(r)};e.labToRGB=function(e,t,n){};return e}();a=function(){function e(){}e.events={};e.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"];e.trigger=function(e,t,n){var r,i,s,o,u;if(this.events[t]&&this.events[t].length){o=this.events[t];u=[];for(i=0,s=o.length;i<s;i++){r=o[i];if(r.target===null||e.id===r.target.id){u.push(r.fn.call(e,n))}else{u.push(void 0)}}return u}};e.listen=function(e,t,n){var r,i;if(typeof e==="string"){i=e;r=t;e=null;t=i;n=r}if(C.call(this.types,t)<0){return false}if(!this.events[t]){this.events[t]=[]}this.events[t].push({target:e,fn:n});return true};return e}();i.Event=a;i.Filter=l=function(){function e(){}e.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6};e.register=function(e,t){return i.prototype[e]=t};return e}();i.IO=c=function(){function e(){}e.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/;e.isRemote=function(e){if(e==null){return false}if(this.corsEnabled(e)){return false}return this.isURLRemote(e.src)};e.corsEnabled=function(e){var t;return e.crossOrigin!=null&&((t=e.crossOrigin.toLowerCase())==="anonymous"||t==="use-credentials")};e.isURLRemote=function(e){var t;t=e.match(this.domainRegex);if(t){return t[1]!==document.domain}else{return false}};e.remoteCheck=function(e){if(this.isURLRemote(e)){if(!i.remoteProxy.length){d.info("Attempting to load a remote image without a configured proxy. URL: "+e)}else{if(i.isURLRemote(i.remoteProxy)){d.info("Cannot use a remote proxy for loading images.");return}return""+i.remoteProxy+"?camanProxyUrl="+encodeURIComponent(e)}}};e.proxyUrl=function(e){return""+i.remoteProxy+"?"+i.proxyParam+"="+encodeURIComponent(e)};e.useProxy=function(e){var t;t={ruby:"rb",python:"py",perl:"pl",javascript:"js"};e=e.toLowerCase();if(t[e]!=null){e=t[e]}return"proxies/caman_proxy."+e};return e}();i.prototype.save=function(){if(typeof exports!=="undefined"&&exports!==null){return this.nodeSave.apply(this,arguments)}else{return this.browserSave.apply(this,arguments)}};i.prototype.browserSave=function(e){var t;if(e==null){e="png"}e=e.toLowerCase();t=this.toBase64(e).replace("image/"+e,"image/octet-stream");return document.location.href=t};i.prototype.nodeSave=function(e,t){var n;if(t==null){t=true}try{n=S.statSync(e);if(n.isFile()&&!t){return false}}catch(r){d.debug("Creating output file "+e)}return S.writeFile(e,this.canvas.toBuffer(),function(){return d.debug("Finished writing to "+e)})};i.prototype.toImage=function(e){var t;t=document.createElement("img");t.src=this.toBase64(e);t.width=this.dimensions.width;t.height=this.dimensions.height;if(window.devicePixelRatio){t.width/=window.devicePixelRatio;t.height/=window.devicePixelRatio}return t};i.prototype.toBase64=function(e){if(e==null){e="png"}e=e.toLowerCase();return this.canvas.toDataURL("image/"+e)};p=function(){function t(e){this.c=e;this.filter=this.c;this.options={blendingMode:"normal",opacity:1};this.layerID=E.uniqid.get();this.canvas=typeof exports!=="undefined"&&exports!==null?new o:document.createElement("canvas");this.canvas.width=this.c.dimensions.width;this.canvas.height=this.c.dimensions.height;this.context=this.canvas.getContext("2d");this.context.createImageData(this.canvas.width,this.canvas.height);this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.pixelData=this.imageData.data}t.prototype.newLayer=function(e){return this.c.newLayer.call(this.c,e)};t.prototype.setBlendingMode=function(e){this.options.blendingMode=e;return this};t.prototype.opacity=function(e){this.options.opacity=e/100;return this};t.prototype.copyParent=function(){var e,t,n,r;t=this.c.pixelData;for(e=n=0,r=this.c.pixelData.length;n<r;e=n+=4){this.pixelData[e]=t[e];this.pixelData[e+1]=t[e+1];this.pixelData[e+2]=t[e+2];this.pixelData[e+3]=t[e+3]}return this};t.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments)};t.prototype.overlayImage=function(t){if(typeof t==="object"){t=t.src}else if(typeof t==="string"&&t[0]==="#"){t=e(t).src}if(!t){return this}this.c.renderer.renderQueue.push({type:l.Type.LoadOverlay,src:t,layer:this});return this};t.prototype.applyToParent=function(){var e,t,r,i,s,o,u,a,f;r=this.c.pixelStack[this.c.pixelStack.length-1];t=this.c.pixelData;f=[];for(e=u=0,a=t.length;u<a;e=u+=4){o={r:r[e],g:r[e+1],b:r[e+2],a:r[e+3]};s={r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]};i=n.execute(this.options.blendingMode,s,o);i.r=E.clampRGB(i.r);i.g=E.clampRGB(i.g);i.b=E.clampRGB(i.b);if(i.a==null){i.a=s.a}r[e]=o.r-(o.r-i.r)*this.options.opacity*(i.a/255);r[e+1]=o.g-(o.g-i.g)*this.options.opacity*(i.a/255);f.push(r[e+2]=o.b-(o.b-i.b)*this.options.opacity*(i.a/255))}return f};return t}();v=function(){function e(){var e,t,n,r;r=["log","info","warn","error"];for(t=0,n=r.length;t<n;t++){e=r[t];this[e]=function(e){return function(){var t;t=1<=arguments.length?k.call(arguments,0):[];if(!i.DEBUG){return}try{return console[e].apply(console,t)}catch(n){return console[e](t)}}}(e)}this.debug=this.log}return e}();d=new v;m=function(){function e(e){this.c=e;this.loc=0}e.coordinatesToLocation=function(e,t,n){return(t*n+e)*4};e.locationToCoordinates=function(e,t){var n,r;r=Math.floor(e/(t*4));n=e%(t*4)/4;return{x:n,y:r}};e.prototype.locationXY=function(){var e,t;t=this.c.dimensions.height-Math.floor(this.loc/(this.c.dimensions.width*4));e=this.loc%(this.c.dimensions.width*4)/4;return{x:e,y:t}};e.prototype.getPixelRelative=function(e,t){var n;n=this.loc+this.c.dimensions.width*4*t*-1+4*e;if(n>this.c.pixelData.length||n<0){return{r:0,g:0,b:0,a:0}}return{r:this.c.pixelData[n],g:this.c.pixelData[n+1],b:this.c.pixelData[n+2],a:this.c.pixelData[n+3]}};e.prototype.putPixelRelative=function(e,t,n){var r;r=this.loc+this.c.dimensions.width*4*t*-1+4*e;if(newLoc>this.c.pixelData.length||newLoc<0){return}this.c.pixelData[newLoc]=n.r;this.c.pixelData[newLoc+1]=n.g;this.c.pixelData[newLoc+2]=n.b;this.c.pixelData[newLoc+3]=n.a;return true};e.prototype.getPixel=function(e,t){var n;n=this.coordinatesToLocation(e,t,this.width);return{r:this.c.pixelData[n],g:this.c.pixelData[n+1],b:this.c.pixelData[n+2],a:this.c.pixelData[n+3]}};e.prototype.putPixel=function(e,t,n){var r;r=this.coordinatesToLocation(e,t,this.width);this.c.pixelData[r]=n.r;this.c.pixelData[r+1]=n.g;this.c.pixelData[r+2]=n.b;return this.c.pixelData[r+3]=n.a};return e}();g=function(){function e(){}e.plugins={};e.register=function(e,t){return this.plugins[e]=t};e.execute=function(e,t,n){return this.plugins[t].apply(e,n)};return e}();i.Plugin=g;i.Renderer=y=function(){function e(t){var n=this;this.c=t;this.processNext=function(){return e.prototype.processNext.apply(n,arguments)};this.renderQueue=[];this.modPixelData=null}e.Blocks=i.NodeJS?require("os").cpus().length:4;e.prototype.add=function(e){if(e==null){return}return this.renderQueue.push(e)};e.prototype.processNext=function(){var e;if(this.renderQueue.length===0){a.trigger(this,"renderFinished");if(this.finishedFn!=null){this.finishedFn.call(this.c)}return this}this.currentJob=this.renderQueue.shift();switch(this.currentJob.type){case l.Type.LayerDequeue:e=this.c.canvasQueue.shift();this.c.executeLayer(e);return this.processNext();case l.Type.LayerFinished:this.c.applyCurrentLayer();this.c.popContext();return this.processNext();case l.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case l.Type.Plugin:return this.executePlugin();default:return this.executeFilter()}};e.prototype.execute=function(e){this.finishedFn=e;this.modPixelData=E.dataArray(this.c.pixelData.length);return this.processNext()};e.prototype.eachBlock=function(t){var n,r,s,o,u,a,l,c,h,p,d,v,m=this;this.blocksDone=0;c=this.c.pixelData.length;r=Math.floor(c/4/e.Blocks);n=r*4;l=n+c/4%e.Blocks*4;v=[];for(a=p=0,d=e.Blocks;0<=d?p<d:p>d;a=0<=d?++p:--p){h=a*n;o=h+(a===e.Blocks-1?l:n);if(i.NodeJS){u=f(function(){return t.call(m,a,h,o)});s=u.run();v.push(this.blockFinished(s))}else{v.push(setTimeout(function(e,n,r){return function(){return t.call(m,e,n,r)}}(a,h,o),0))}}return v};e.prototype.executeFilter=function(){a.trigger(this.c,"processStart",this.currentJob);if(this.currentJob.type===l.Type.Single){return this.eachBlock(this.renderBlock)}else{return this.eachBlock(this.renderKernel)}};e.prototype.executePlugin=function(){d.debug("Executing plugin "+this.currentJob.plugin);g.execute(this.c,this.currentJob.plugin,this.currentJob.args);d.debug("Plugin "+this.currentJob.plugin+" finished!");return this.processNext()};e.prototype.renderBlock=function(t,n,r){var s,o,u,l,c;d.debug("Block #"+t+" - Filter: "+this.currentJob.name+", Start: "+n+", End: "+r);a.trigger(this.c,"blockStarted",{blockNum:t,totalBlocks:e.Blocks,startPixel:n,endPixel:r});s={r:0,g:0,b:0,a:0};u=new m(this.c);for(o=c=n;c<r;o=c+=4){u.loc=o;s.r=this.c.pixelData[o];s.g=this.c.pixelData[o+1];s.b=this.c.pixelData[o+2];s.a=this.c.pixelData[o+3];l=this.currentJob.processFn.call(u,s);if(l.a==null){l.a=s.a}this.c.pixelData[o]=E.clampRGB(l.r);this.c.pixelData[o+1]=E.clampRGB(l.g);this.c.pixelData[o+2]=E.clampRGB(l.b);this.c.pixelData[o+3]=E.clampRGB(l.a)}if(i.NodeJS){return f["yield"](t)}else{return this.blockFinished(t)}};e.prototype.renderKernel=function(e,t,n){var r,s,o,u,a,l,c,h,p,v,g,y,b,w,S,x,T,N;y=this.currentJob.name;o=this.currentJob.bias;l=this.currentJob.divisor;g=this.c.pixelData.length;r=this.currentJob.adjust;s=Math.sqrt(r.length);v=[];d.debug("Rendering kernel - Filter: "+this.currentJob.name);t=Math.max(t,this.c.dimensions.width*4*((s-1)/2));n=Math.min(n,g-this.c.dimensions.width*4*((s-1)/2));u=(s-1)/2;w=new m(this.c);for(c=x=t;x<n;c=x+=4){w.loc=c;a=0;for(h=T=-u;-u<=u?T<=u:T>=u;h=-u<=u?++T:--T){for(p=N=u;u<=-u?N<=-u:N>=-u;p=u<=-u?++N:--N){b=w.getPixelRelative(h,p);v[a*3]=b.r;v[a*3+1]=b.g;v[a*3+2]=b.b;a++}}S=this.processKernel(r,v,l,o);this.modPixelData[c]=E.clampRGB(S.r);this.modPixelData[c+1]=E.clampRGB(S.g);this.modPixelData[c+2]=E.clampRGB(S.b);this.modPixelData[c+3]=this.c.pixelData[c+3]}if(i.NodeJS){return f["yield"](e)}else{return this.blockFinished(e)}};e.prototype.blockFinished=function(t){var n,r,i;if(t>=0){d.debug("Block #"+t+" finished! Filter: "+this.currentJob.name)}this.blocksDone++;a.trigger(this.c,"blockFinished",{blockNum:t,blocksFinished:this.blocksDone,totalBlocks:e.Blocks});if(this.blocksDone===e.Blocks){if(this.currentJob.type===l.Type.Kernel){for(n=r=0,i=this.c.pixelData.length;0<=i?r<i:r>i;n=0<=i?++r:--r){this.c.pixelData[n]=this.modPixelData[n]}}if(t>=0){d.debug("Filter "+this.currentJob.name+" finished!")}a.trigger(this.c,"processComplete",this.currentJob);return this.processNext()}};e.prototype.processKernel=function(e,t,n,r){var i,s,o,u;s={r:0,g:0,b:0};for(i=o=0,u=e.length;0<=u?o<u:o>u;i=0<=u?++o:--o){s.r+=e[i]*t[i*3];s.g+=e[i]*t[i*3+1];s.b+=e[i]*t[i*3+2]}s.r=s.r/n+r;s.g=s.g/n+r;s.b=s.b/n+r;return s};e.prototype.loadOverlay=function(e,t){var n,r,i=this;n=document.createElement("img");n.onload=function(){e.context.drawImage(n,0,0,i.c.dimensions.width,i.c.dimensions.height);e.imageData=e.context.getImageData(0,0,i.c.dimensions.width,i.c.dimensions.height);e.pixelData=e.imageData.data;i.c.pixelData=e.pixelData;return i.processNext()};r=c.remoteCheck(t);return n.src=r!=null?r:t};return e}();i.Store=w=function(){function e(){}e.items={};e.has=function(e){return this.items[e]!=null};e.get=function(e){return this.items[e]};e.put=function(e,t){return this.items[e]=t};e.execute=function(e,t){var n=this;setTimeout(function(){return t.call(n.get(e),n.get(e))},0);return this.get(e)};e.flush=function(e){if(e==null){e=false}if(e){return delete this.items[e]}else{return this.items={}}};return e}();n.register("normal",function(e,t){return{r:e.r,g:e.g,b:e.b}});n.register("multiply",function(e,t){return{r:e.r*t.r/255,g:e.g*t.g/255,b:e.b*t.b/255}});n.register("screen",function(e,t){return{r:255-(255-e.r)*(255-t.r)/255,g:255-(255-e.g)*(255-t.g)/255,b:255-(255-e.b)*(255-t.b)/255}});n.register("overlay",function(e,t){var n;n={};n.r=t.r>128?255-2*(255-e.r)*(255-t.r)/255:t.r*e.r*2/255;n.g=t.g>128?255-2*(255-e.g)*(255-t.g)/255:t.g*e.g*2/255;n.b=t.b>128?255-2*(255-e.b)*(255-t.b)/255:t.b*e.b*2/255;return n});n.register("difference",function(e,t){return{r:e.r-t.r,g:e.g-t.g,b:e.b-t.b}});n.register("addition",function(e,t){return{r:t.r+e.r,g:t.g+e.g,b:t.b+e.b}});n.register("exclusion",function(e,t){return{r:128-2*(t.r-128)*(e.r-128)/255,g:128-2*(t.g-128)*(e.g-128)/255,b:128-2*(t.b-128)*(e.b-128)/255}});n.register("softLight",function(e,t){var n;n={};n.r=t.r>128?255-(255-t.r)*(255-(e.r-128))/255:t.r*(e.r+128)/255;n.g=t.g>128?255-(255-t.g)*(255-(e.g-128))/255:t.g*(e.g+128)/255;n.b=t.b>128?255-(255-t.b)*(255-(e.b-128))/255:t.b*(e.b+128)/255;return n});n.register("lighten",function(e,t){return{r:t.r>e.r?t.r:e.r,g:t.g>e.g?t.g:e.g,b:t.b>e.b?t.b:e.b}});n.register("darken",function(e,t){return{r:t.r>e.r?e.r:t.r,g:t.g>e.g?e.g:t.g,b:t.b>e.b?e.b:t.b}});n.register("cutToWhite",function(e,t){var n=e.r/255;return{r:lerp(t.r,255,n),g:lerp(t.g,255,n),b:lerp(t.b,255,n)}});l.register("fillColor",function(){var e;if(arguments.length===1){e=u.hexToRGB(arguments[0])}else{e={r:arguments[0],g:arguments[1],b:arguments[2]}}return this.process("fillColor",function(t){t.r=e.r;t.g=e.g;t.b=e.b;t.a=255;return t})});l.register("brightness",function(e){e=Math.floor(255*(e/100));return this.process("brightness",function(t){t.r+=e;t.g+=e;t.b+=e;return t})});l.register("saturation",function(e){e*=-.01;return this.process("saturation",function(t){var n;n=Math.max(t.r,t.g,t.b);if(t.r!==n){t.r+=(n-t.r)*e}if(t.g!==n){t.g+=(n-t.g)*e}if(t.b!==n){t.b+=(n-t.b)*e}return t})});l.register("lowEnd",function(e){return this.process("vibrance",function(t){t.r=lerp(0,255,Math.max(0,t.r-e)*(255/(255-e))/255);t.g=lerp(0,255,Math.max(0,t.g-e)*(255/(255-e))/255);t.b=lerp(0,255,Math.max(0,t.b-e)*(255/(255-e))/255);return t})});l.register("vibrance",function(e){e*=-1;return this.process("vibrance",function(t){var n,r,i;i=Math.max(t.r,t.g,t.b);r=(t.r+t.g+t.b)/3;n=Math.abs(i-r)*2/255*e/100;if(t.r!==i){t.r+=(i-t.r)*n}if(t.g!==i){t.g+=(i-t.g)*n}if(t.b!==i){t.b+=(i-t.b)*n}return t})});l.register("greyscale",function(e){return this.process("greyscale",function(e){var t;t=r.luminance(e);e.r=t;e.g=t;e.b=t;return e})});l.register("contrast",function(e){e=Math.pow((e+100)/100,2);return this.process("contrast",function(t){t.r/=255;t.r-=.5;t.r*=e;t.r+=.5;t.r*=255;t.g/=255;t.g-=.5;t.g*=e;t.g+=.5;t.g*=255;t.b/=255;t.b-=.5;t.b*=e;t.b+=.5;t.b*=255;return t})});l.register("hue",function(e){return this.process("hue",function(t){var n,r,i;r=u.rgbToHSV(t.r,t.g,t.b);n=r.h*100;n+=Math.abs(e);n=n%100;n/=100;r.h=n;i=u.hsvToRGB(r.h,r.s,r.v);i.a=t.a;return i})});l.register("colorize",function(){var e,t;if(arguments.length===2){t=u.hexToRGB(arguments[0]);e=arguments[1]}else if(arguments.length===4){t={r:arguments[0],g:arguments[1],b:arguments[2]};e=arguments[3]}return this.process("colorize",function(n){n.r-=(n.r-t.r)*(e/100);n.g-=(n.g-t.g)*(e/100);n.b-=(n.b-t.b)*(e/100);return n})});l.register("invert",function(){return this.process("invert",function(e){e.r=255-e.r;e.g=255-e.g;e.b=255-e.b;return e})});l.register("sepia",function(e){if(e==null){e=100}e/=100;return this.process("sepia",function(t){t.r=Math.min(255,t.r*(1-.607*e)+t.g*.769*e+t.b*.189*e);t.g=Math.min(255,t.r*.349*e+t.g*(1-.314*e)+t.b*.168*e);t.b=Math.min(255,t.r*.272*e+t.g*.534*e+t.b*(1-.869*e));return t})});l.register("gamma",function(e){return this.process("gamma",function(t){t.r=Math.pow(t.r/255,e)*255;t.g=Math.pow(t.g/255,e)*255;t.b=Math.pow(t.b/255,e)*255;return t})});l.register("noise",function(e){e=Math.abs(e)*2.55;return this.process("noise",function(t){var n;n=r.randomRange(e*-1,e);t.r+=n;t.g+=n;t.b+=n;return t})});l.register("clip",function(e){e=Math.abs(e)*2.55;return this.process("clip",function(t){if(t.r>255-e){t.r=255}else if(t.r<e){t.r=0}if(t.g>255-e){t.g=255}else if(t.g<e){t.g=0}if(t.b>255-e){t.b=255}else if(t.b<e){t.b=0}return t})});l.register("channels",function(e){var t,n;if(typeof e!=="object"){return this}for(t in e){if(!N.call(e,t))continue;n=e[t];if(n===0){delete e[t];continue}e[t]/=100}if(e.length===0){return this}return this.process("channels",function(t){if(e.red!=null){if(e.red>0){t.r+=(255-t.r)*e.red}else{t.r-=t.r*Math.abs(e.red)}}if(e.green!=null){if(e.green>0){t.g+=(255-t.g)*e.green}else{t.g-=t.g*Math.abs(e.green)}}if(e.blue!=null){if(e.blue>0){t.b+=(255-t.b)*e.blue}else{t.b-=t.b*Math.abs(e.blue)}}return t})});l.register("curves",function(){var e,t,n,i,s,o,u,a,f,l,c,h;t=arguments[0],n=2<=arguments.length?k.call(arguments,1):[];if(typeof t==="string"){t=t.split("")}if(t[0]==="v"){t=["r","g","b"]}if(n.length<3||n.length>4){throw"Invalid number of arguments to curves filter"}a=n[0];i=n[1];s=n.length===4?n[2]:n[1];o=n[n.length-1];e=r.bezier(a,i,s,o,0,255);if(a[0]>0){for(u=f=0,c=a[0];0<=c?f<c:f>c;u=0<=c?++f:--f){e[u]=a[1]}}if(o[0]<255){for(u=l=h=o[0];h<=255?l<=255:l>=255;u=h<=255?++l:--l){e[u]=o[1]}}return this.process("curves",function(n){var r,i;for(u=r=0,i=t.length;0<=i?r<i:r>i;u=0<=i?++r:--r){n[t[u]]=e[n[t[u]]]}return n})});l.register("exposure",function(e){var t,n,r;r=Math.abs(e)/100;t=[0,255*r];n=[255-255*r,255];if(e<0){t=t.reverse();n=n.reverse()}return this.curves("rgb",[0,0],t,n,[255,255])});i.Plugin.register("crop",function(e,t,n,r){var i,s;if(n==null){n=0}if(r==null){r=0}if(typeof exports!=="undefined"&&exports!==null){i=new o(e,t)}else{i=document.createElement("canvas");E.copyAttributes(this.canvas,i);i.width=e;i.height=t}s=i.getContext("2d");s.drawImage(this.canvas,n,r,e,t,0,0,e,t);this.cropCoordinates={x:n,y:r};this.cropped=true;return this.replaceCanvas(i)});i.Plugin.register("resize",function(e){var t,n;if(e==null){e=null}if(e===null||e.width==null&&e.height==null){d.error("Invalid or missing dimensions given for resize");return}if(e.width==null){e.width=this.canvas.width*e.height/this.canvas.height}else if(e.height==null){e.height=this.canvas.height*e.width/this.canvas.width}if(typeof exports!=="undefined"&&exports!==null){t=new o(e.width,e.height)}else{t=document.createElement("canvas");E.copyAttributes(this.canvas,t);t.width=e.width;t.height=e.height}n=t.getContext("2d");n.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,e.width,e.height);this.resized=true;return this.replaceCanvas(t)});i.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0))});i.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0))});i.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])});i.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])});i.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])});i.Filter.register("motionBlur",function(e){var t;if(e===0||e===180){t=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]}else if(e>0&&e<90||e>180&&e<270){t=[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]}else if(e===90||e===270){t=[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]}else{t=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]}return this.processKernel("Motion Blur",t)});i.Filter.register("sharpen",function(e){if(e==null){e=100}e/=100;return this.processKernel("Sharpen",[0,-e,0,-e,4*e+1,-e,0,-e,0])});T={brightness:function(e,t,n){e.r=e.r-e.r*t*n.strength;e.g=e.g-e.g*t*n.strength;e.b=e.b-e.b*t*n.strength;return e},gamma:function(e,t,n){e.r=Math.pow(e.r/255,Math.max(10*t*n.strength,1))*255;e.g=Math.pow(e.g/255,Math.max(10*t*n.strength,1))*255;e.b=Math.pow(e.b/255,Math.max(10*t*n.strength,1))*255;return e},colorize:function(e,t,n){e.r-=(e.r-n.color.r)*t;e.g-=(e.g-n.color.g)*t;e.b-=(e.b-n.color.b)*t;return e}};l.register("vignette",function(e,t){var n,i,s,o;if(t==null){t=60}if(typeof e==="string"&&e.substr(-1)==="%"){if(this.dimensions.height>this.dimensions.width){e=this.dimensions.width*(parseInt(e.substr(0,e.length-1),10)/100)}else{e=this.dimensions.height*(parseInt(e.substr(0,e.length-1),10)/100)}}t/=100;i=[this.dimensions.width/2,this.dimensions.height/2];o=Math.sqrt(Math.pow(i[0],2)+Math.pow(i[1],2));s=o-e;n=r.bezier([0,1],[30,30],[70,60],[100,80]);return this.process("vignette",function(o){var u,a,f;f=this.locationXY();u=r.distance(f.x,f.y,i[0],i[1]);if(u>s){a=Math.max(1,n[Math.round((u-s)/e*100)]/10*t);o.r=Math.pow(o.r/255,a)*255;o.g=Math.pow(o.g/255,a)*255;o.b=Math.pow(o.b/255,a)*255}return o})});l.register("rectangularVignette",function(e){var t,n,s,o,a,f,l;t={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}};e=E.extend(t,e);if(!e.size){return this}else if(typeof e.size==="string"){s=parseInt(e.size,10)/100;e.size={width:this.dimensions.width*s,height:this.dimensions.height*s}}else if(typeof e.size==="object"){l=["width","height"];for(a=0,f=l.length;a<f;a++){n=l[a];if(typeof e.size[n]==="string"){e.size[n]=this.dimensions[n]*(parseInt(e.size[n],10)/100)}}}else if(e.size==="number"){o=e.size;e.size={width:o,height:o}}if(typeof e.cornerRadius==="string"){e.cornerRadius=e.size.width/2*(parseInt(e.cornerRadius,10)/100)}e.strength/=100;e.size.width=Math.floor(e.size.width);e.size.height=Math.floor(e.size.height);e.image={width:this.dimensions.width,height:this.dimensions.height};if(e.method==="colorize"&&typeof e.color==="string"){e.color=u.hexToRGB(e.color)}e.coords={left:(this.dimensions.width-e.size.width)/2,right:this.dimensions.width-e.coords.left,bottom:(this.dimensions.height-e.size.height)/2,top:this.dimensions.height-e.coords.bottom};e.corners=[{x:e.coords.left+e.cornerRadius,y:e.coords.top-e.cornerRadius},{x:e.coords.right-e.cornerRadius,y:e.coords.top-e.cornerRadius},{x:e.coords.right-e.cornerRadius,y:e.coords.bottom+e.cornerRadius},{x:e.coords.left+e.cornerRadius,y:e.coords.bottom+e.cornerRadius}];e.maxDist=r.distance(0,0,e.corners[3].x,e.corners[3].y)-e.cornerRadius;return this.process("rectangularVignette",function(t){var n,r,s;r=this.locationXY();if(r.x>e.corners[0].x&&r.x<e.corners[1].x&&r.y>e.coords.bottom&&r.y<e.coords.top){return t}if(r.x>e.coords.left&&r.x<e.coords.right&&r.y>e.corners[3].y&&r.y<e.corners[2].y){return t}if(r.x>e.corners[0].x&&r.x<e.corners[1].x&&r.y>e.coords.top){n=(r.y-e.coords.top)/e.maxDist}else if(r.y>e.corners[2].y&&r.y<e.corners[1].y&&r.x>e.coords.right){n=(r.x-e.coords.right)/e.maxDist}else if(r.x>e.corners[0].x&&r.x<e.corners[1].x&&r.y<e.coords.bottom){n=(e.coords.bottom-r.y)/e.maxDist}else if(r.y>e.corners[2].y&&r.y<e.corners[1].y&&r.x<e.coords.left){n=(e.coords.left-r.x)/e.maxDist}else if(r.x<=e.corners[0].x&&r.y>=e.corners[0].y){s=i.distance(r.x,r.y,e.corners[0].x,e.corners[0].y);n=(s-e.cornerRadius)/e.maxDist}else if(r.x>=e.corners[1].x&&r.y>=e.corners[1].y){s=i.distance(r.x,r.y,e.corners[1].x,e.corners[1].y);n=(s-e.cornerRadius)/e.maxDist}else if(r.x>=e.corners[2].x&&r.y<=e.corners[2].y){s=i.distance(r.x,r.y,e.corners[2].x,e.corners[2].y);n=(s-e.cornerRadius)/e.maxDist}else if(r.x<=e.corners[3].x&&r.y<=e.corners[3].y){s=i.distance(r.x,r.y,e.corners[3].x,e.corners[3].y);n=(s-e.cornerRadius)/e.maxDist}if(n<0){return t}return T[e.method](t,n,e)})});(function(){var e,t,n,r,s;r=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];s=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];t=function(e,t,n,r,i,s,u){var a,f,l,c,h,p,d;a=typeof exports!=="undefined"&&exports!==null?new o:document.createElement("canvas");a.width=e;a.height=t;c=n+Math.cos(i)*s*.5;p=r+Math.sin(i)*s*.5;h=n-Math.cos(i)*s*.5;d=r-Math.sin(i)*s*.5;f=a.getContext("2d");l=f.createLinearGradient(c,p,h,d);if(!u){l.addColorStop(0,"white");l.addColorStop(1,"black")}else{l.addColorStop(0,"white");l.addColorStop(.5,"black");l.addColorStop(1,"white")}f.fillStyle=l;f.fillRect(0,0,e,t);return f.getImageData(0,0,e,t)};n=function(e,t,n,r,i,s){var u,a,f;u=typeof exports!=="undefined"&&exports!==null?new o:document.createElement("canvas");u.width=e;u.height=t;a=u.getContext("2d");f=a.createRadialGradient(n,r,i,n,r,s);f.addColorStop(1,"white");f.addColorStop(0,"black");a.fillStyle=f;a.fillRect(0,0,e,t);return a.getImageData(0,0,e,t)};e=function(){this.r=0;this.g=0;this.b=0;this.a=0;return this.next=null};i.Plugin.register("compoundBlur",function(t,n,i,o){var u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt;J=this.dimensions.width;m=this.dimensions.height;E=this.pixelData;P=t.data;V=J*m;$=V<<2;A=[];for(y=tt=0;0<=$?tt<$:tt>$;y=0<=$?++tt:--tt){A[y]=E[y]}c=0;z=o;o-=1;while(z-->=0){x=n+.5|0;if(x===0){continue}if(x>256){x=256}h=x+x+1;X=J<<2;K=J-1;g=m-1;H=x+1;W=H*(H+1)/2;U=new e;I=void 0;F=U;for(y=nt=1;1<=h?nt<h:nt>h;y=1<=h?++nt:--nt){F=F.next=new e;if(y===H){I=F}}F.next=U;q=null;R=null;et=Y=0;N=r[x];j=s[x];for(G=rt=0;0<=m?rt<m:rt>m;G=0<=m?++rt:--rt){M=p=u=D=v=f=0;_=H*(O=A[Y]);d=H*(L=A[Y+1]);a=H*(k=A[Y+2]);D+=W*O;v+=W*L;f+=W*k;F=U;for(y=it=0;0<=H?it<H:it>H;y=0<=H?++it:--it){F.r=O;F.g=L;F.b=k;F=F.next}for(y=st=1;1<=H?st<H:st>H;y=1<=H?++st:--st){C=Y+((K<y?K:y)<<2);D+=(F.r=O=A[C])*(B=H-y);v+=(F.g=L=A[C+1])*B;f+=(F.b=k=A[C+2])*B;M+=O;p+=L;u+=k;F=F.next}q=U;R=I;for(Q=ot=0;0<=J?ot<J:ot>J;Q=0<=J?++ot:--ot){A[Y]=D*N>>j;A[Y+1]=v*N>>j;A[Y+2]=f*N>>j;D-=_;v-=d;f-=a;_-=q.r;d-=q.g;a-=q.b;C=et+((C=Q+H)<K?C:K)<<2;M+=q.r=A[C];p+=q.g=A[C+1];u+=q.b=A[C+2];D+=M;v+=p;f+=u;q=q.next;_+=O=R.r;d+=L=R.g;a+=k=R.b;M-=O;p-=L;u-=k;R=R.next;Y+=4}et+=J}for(Q=ut=0;0<=J?ut<J:ut>J;Q=0<=J?++ut:--ut){p=u=M=v=f=D=0;Y=Q<<2;_=H*(O=A[Y]);d=H*(L=A[Y+1]);a=H*(k=A[Y+2]);D+=W*O;v+=W*L;f+=W*k;F=U;for(y=at=0;0<=H?at<H:at>H;y=0<=H?++at:--at){F.r=O;F.g=L;F.b=k;F=F.next}Z=J;for(y=ft=1;1<=H?ft<H:ft>H;y=1<=H?++ft:--ft){Y=Z+Q<<2;D+=(F.r=O=A[Y])*(B=H-y);v+=(F.g=L=A[Y+1])*B;f+=(F.b=k=A[Y+2])*B;M+=O;p+=L;u+=k;F=F.next;if(y<g){Z+=J}}Y=Q;q=U;R=I;for(G=lt=0;0<=m?lt<m:lt>m;G=0<=m?++lt:--lt){C=Y<<2;A[C]=D*N>>j;A[C+1]=v*N>>j;A[C+2]=f*N>>j;D-=_;v-=d;f-=a;_-=q.r;d-=q.g;a-=q.b;C=Q+((C=G+H)<g?C:g)*J<<2;D+=M+=q.r=A[C];v+=p+=q.g=A[C+1];f+=u+=q.b=A[C+2];q=q.next;_+=O=R.r;d+=L=R.g;a+=k=R.b;M-=O;p-=L;u-=k;R=R.next;Y+=J}}n*=i;y=V;while(--y>-1){w=y<<2;T=(P[w+2]&255)/255*o;S=T|0;if(S===c){l=256*(T-(T|0));b=256-l;E[w]=E[w]*b+A[w]*l>>8;E[w+1]=E[w+1]*b+A[w+1]*l>>8;E[w+2]=E[w+2]*b+A[w+2]*l>>8}else if(S===c+1){E[w]=A[w];E[w+1]=A[w+1];E[w+2]=A[w+2]}}c++}return this});i.Filter.register("tiltShift",function(e){var n,r;n={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3};e=E.extend(n,e);e.angle*=Math.PI/180;r=t(this.dimensions.width,this.dimensions.height,e.center.x,e.center.y,e.angle,e.focusWidth,true);return this.processPlugin("compoundBlur",[r,e.startRadius,e.radiusFactor,e.steps])});return i.Filter.register("radialBlur",function(e){var t,r,i,s;t={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null};e=E.extend(t,e);if(!e.radius){e.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width}i=e.radius/2-e.size;s=e.radius/2;r=n(this.dimensions.width,this.dimensions.height,e.center.x,e.center.y,i,s);return this.processPlugin("compoundBlur",[r,e.startRadius,e.radiusFactor,e.steps])})})();i.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0])});i.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1])});i.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2])});i.Filter.register("posterize",function(e){var t,n;t=256/e;n=255/(e-1);return this.process("posterize",function(e){e.r=Math.floor(Math.floor(e.r/t)*n);e.g=Math.floor(Math.floor(e.g/t)*n);e.b=Math.floor(Math.floor(e.b/t)*n);return e})});i.Filter.register("vintage",function(e){if(e==null){e=true}this.greyscale();this.contrast(5);this.noise(3);this.sepia(100);this.channels({red:8,blue:2,green:4});this.gamma(.87);if(e){return this.vignette("40%",30)}});i.Filter.register("lomo",function(e){if(e==null){e=true}this.brightness(15);this.exposure(15);this.curves("rgb",[0,0],[200,0],[155,255],[255,255]);this.saturation(-20);this.gamma(1.8);if(e){this.vignette("50%",60)}return this.brightness(5)});i.Filter.register("clarity",function(e){if(e==null){e=false}this.vibrance(20);this.curves("rgb",[5,0],[130,150],[190,220],[250,255]);this.sharpen(15);this.vignette("45%",20);if(e){this.greyscale();this.contrast(4)}return this});i.Filter.register("sinCity",function(){this.contrast(100);this.brightness(15);this.exposure(10);this.posterize(80);this.clip(30);return this.greyscale()});i.Filter.register("sunrise",function(){this.exposure(3.5);this.saturation(-5);this.vibrance(50);this.sepia(60);this.colorize("#e87b22",10);this.channels({red:8,blue:8});this.contrast(5);this.gamma(1.2);return this.vignette("55%",25)});i.Filter.register("crossProcess",function(){this.exposure(5);this.colorize("#e87b22",4);this.sepia(20);this.channels({blue:8,red:3});this.curves("b",[0,0],[100,150],[180,180],[255,255]);this.contrast(15);this.vibrance(75);return this.gamma(1.6)});i.Filter.register("orangePeel",function(){this.curves("rgb",[0,0],[100,50],[140,200],[255,255]);this.vibrance(-30);this.saturation(-30);this.colorize("#ff9000",30);this.contrast(-5);return this.gamma(1.4)});i.Filter.register("love",function(){this.brightness(5);this.exposure(8);this.contrast(4);this.colorize("#c42007",30);this.vibrance(50);return this.gamma(1.3)});i.Filter.register("grungy",function(){this.gamma(1.5);this.clip(25);this.saturation(-60);this.contrast(5);this.noise(5);return this.vignette("50%",30)});i.Filter.register("jarques",function(){this.saturation(-35);this.curves("b",[20,0],[90,120],[186,144],[255,230]);this.curves("r",[0,0],[144,90],[138,120],[255,255]);this.curves("g",[10,0],[115,105],[148,100],[255,248]);this.curves("rgb",[0,0],[120,100],[128,140],[255,255]);return this.sharpen(20)});i.Filter.register("pinhole",function(){this.greyscale();this.sepia(10);this.exposure(10);this.contrast(15);return this.vignette("60%",35)});i.Filter.register("oldBoot",function(){this.saturation(-20);this.vibrance(-50);this.gamma(1.1);this.sepia(30);this.channels({red:-10,blue:5});this.curves("rgb",[0,0],[80,50],[128,230],[255,255]);return this.vignette("60%",30)});i.Filter.register("glowingSun",function(e){if(e==null){e=true}this.brightness(10);this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(80);this.copyParent();this.filter.gamma(.8);this.filter.contrast(50);return this.filter.exposure(10)});this.newLayer(function(){this.setBlendingMode("softLight");this.opacity(80);return this.fillColor("#f49600")});this.exposure(20);this.gamma(.8);if(e){return this.vignette("45%",20)}});i.Filter.register("hazyDays",function(){this.gamma(1.2);this.newLayer(function(){this.setBlendingMode("overlay");this.opacity(60);this.copyParent();this.filter.channels({red:5});return this.filter.stackBlur(15)});this.newLayer(function(){this.setBlendingMode("addition");this.opacity(40);return this.fillColor("#6899ba")});this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(35);this.copyParent();this.filter.brightness(40);this.filter.vibrance(40);this.filter.exposure(30);this.filter.contrast(15);this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]);this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]);this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]);return this.filter.stackBlur(5)});this.curves("r",[20,0],[128,158],[128,128],[235,255]);this.curves("g",[20,0],[128,128],[128,128],[235,255]);this.curves("b",[20,0],[128,108],[128,128],[235,255]);return this.vignette("45%",20)});i.Filter.register("herMajesty",function(){this.brightness(40);this.colorize("#ea1c5d",10);this.curves("b",[0,10],[128,180],[190,190],[255,255]);this.newLayer(function(){this.setBlendingMode("overlay");this.opacity(50);this.copyParent();this.filter.gamma(.7);return this.newLayer(function(){this.setBlendingMode("normal");this.opacity(60);return this.fillColor("#ea1c5d")})});this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(60);this.copyParent();this.filter.saturation(50);this.filter.hue(90);return this.filter.contrast(10)});this.gamma(1.4);this.vibrance(-30);this.newLayer(function(){this.opacity(10);return this.fillColor("#e5f0ff")});return this});i.Filter.register("nostalgia",function(){this.saturation(20);this.gamma(1.4);this.greyscale();this.contrast(5);this.sepia(100);this.channels({red:8,blue:2,green:4});this.gamma(.8);this.contrast(5);this.exposure(10);this.newLayer(function(){this.setBlendingMode("overlay");this.copyParent();this.opacity(55);return this.filter.stackBlur(10)});return this.vignette("50%",30)});i.Filter.register("hemingway",function(){this.greyscale();this.contrast(10);this.gamma(.9);this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(40);this.copyParent();this.filter.exposure(15);this.filter.contrast(15);return this.filter.channels({green:10,red:5})});this.sepia(30);this.curves("rgb",[0,10],[120,90],[180,200],[235,255]);this.channels({red:5,green:-2});return this.exposure(15)});i.Filter.register("concentrate",function(){this.sharpen(40);this.saturation(-50);this.channels({red:3});this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(80);this.copyParent();this.filter.sharpen(5);this.filter.contrast(50);this.filter.exposure(10);return this.filter.channels({blue:5})});return this.brightness(10)});(function(){var e,t,n;t=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];n=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];e=function(){this.r=0;this.g=0;this.b=0;this.a=0;return this.next=null};i.Plugin.register("stackBlur",function(r){var i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J;if(isNaN(r)||r<1){return}r|=0;y=this.pixelData;D=this.dimensions.width;c=this.dimensions.height;u=r+r+1;_=D<<2;P=D-1;h=c-1;x=r+1;M=x*(x+1)/2;O=new e;C=O;for(p=q=1;1<=u?q<u:q>u;p=1<=u?++q:--q){C=C.next=new e;if(p===x){k=C}}C.next=O;L=null;A=null;I=j=0;d=t[r];N=n[r];for(B=R=0;0<=c?R<c:R>c;B=0<=c?++R:--R){w=a=i=S=l=o=0;E=x*(b=y[j]);f=x*(g=y[j+1]);s=x*(m=y[j+2]);S+=M*b;l+=M*g;o+=M*m;C=O;for(p=U=0;0<=x?U<x:U>x;p=0<=x?++U:--U){C.r=b;C.g=g;C.b=m;C=C.next}for(p=z=1;1<=x?z<x:z>x;p=1<=x?++z:--z){v=j+((P<p?P:p)<<2);S+=(C.r=b=y[v])*(T=x-p);l+=(C.g=g=y[v+1])*T;o+=(C.b=m=y[v+2])*T;w+=b;a+=g;i+=m;C=C.next}L=O;A=k;for(H=W=0;0<=D?W<D:W>D;H=0<=D?++W:--W){y[j]=S*d>>N;y[j+1]=l*d>>N;y[j+2]=o*d>>N;S-=E;l-=f;o-=s;E-=L.r;f-=L.g;s-=L.b;v=I+((v=H+r+1)<P?v:P)<<2;w+=L.r=y[v];a+=L.g=y[v+1];i+=L.b=y[v+2];S+=w;l+=a;o+=i;L=L.next;E+=b=A.r;f+=g=A.g;s+=m=A.b;w-=b;a-=g;i-=m;A=A.next;j+=4}I+=D}for(H=X=0;0<=D?X<D:X>D;H=0<=D?++X:--X){a=i=w=l=o=S=0;j=H<<2;E=x*(b=y[j]);f=x*(g=y[j+1]);s=x*(m=y[j+2]);S+=M*b;l+=M*g;o+=M*m;C=O;for(p=V=0;0<=x?V<x:V>x;p=0<=x?++V:--V){C.r=b;C.g=g;C.b=m;C=C.next}F=D;for(p=$=1;1<=r?$<=r:$>=r;p=1<=r?++$:--$){j=F+H<<2;S+=(C.r=b=y[j])*(T=x-p);l+=(C.g=g=y[j+1])*T;o+=(C.b=m=y[j+2])*T;w+=b;a+=g;i+=m;C=C.next;if(p<h){F+=D}}j=H;L=O;A=k;for(B=J=0;0<=c?J<c:J>c;B=0<=c?++J:--J){v=j<<2;y[v]=S*d>>N;y[v+1]=l*d>>N;y[v+2]=o*d>>N;S-=E;l-=f;o-=s;E-=L.r;f-=L.g;s-=L.b;v=H+((v=B+x)<h?v:h)*D<<2;S+=w+=L.r=y[v];l+=a+=L.g=y[v+1];o+=i+=L.b=y[v+2];L=L.next;E+=b=A.r;f+=g=A.g;s+=m=A.b;w-=b;a-=g;i-=m;A=A.next;j+=D}}return this});return i.Filter.register("stackBlur",function(e){return this.processPlugin("stackBlur",[e])})})();i.Filter.register("threshold",function(e){return this.process("threshold",function(t){var n;n=.2126*t.r+.7152*t.g+.0722*t.b;if(n<e){t.r=0;t.g=0;t.b=0}else{t.r=255;t.g=255;t.b=255}return t})})}).call(this)